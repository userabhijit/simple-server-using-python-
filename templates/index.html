<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Server</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Upload a File</h1>
        <div class="allowed-extensions" style="margin-bottom: 16px; padding: 10px; background: #f0f4f8; border-radius: 6px; color: #333; font-size: 1.08em;">
            <strong>Allowed file extensions:</strong>
            <span>
                {% for ext in allowed_exts %}
                    .{{ ext }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </span>
        </div>
        <form id="uploadForm" method="post" enctype="multipart/form-data" style="display: flex; align-items: center; gap: 16px; margin-bottom: 18px;">
            <input type="file" id="fileInput" name="file" multiple style="display:none;">
            <input type="file" id="folderInput" name="files" multiple webkitdirectory directory style="display:none;">
            <button type="button" id="chooseBtn" style="background: #007bff; color: #fff;">Choose</button>
        </form>
        <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.55); z-index:1000; align-items:center; justify-content:center;">
            <div style="background:#fff; padding:32px 28px; border-radius:10px; box-shadow:0 4px 32px rgba(0,0,0,0.18); min-width:260px; text-align:center;">
                <h2 style="margin-bottom:18px; font-size:1.25em;">What would you like to upload?</h2>
                <button id="modalFilesBtn" style="background:#007bff; color:#fff; margin:0 10px 0 0; padding:10px 22px; border:none; border-radius:6px; font-size:1em; cursor:pointer;">Files</button>
                <button id="modalFolderBtn" style="background:#28a745; color:#fff; padding:10px 22px; border:none; border-radius:6px; font-size:1em; cursor:pointer;">Folder</button>
            </div>
        </div>
        <script>
            // Modal logic
            const chooseBtn = document.getElementById('chooseBtn');
            const modalOverlay = document.getElementById('modalOverlay');
            const modalFilesBtn = document.getElementById('modalFilesBtn');
            const modalFolderBtn = document.getElementById('modalFolderBtn');
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');
            // Show modal on choose
            chooseBtn.onclick = function() {
                modalOverlay.style.display = 'flex';
            };
            // Hide modal and trigger file input
            modalFilesBtn.onclick = function() {
                modalOverlay.style.display = 'none';
                fileInput.click();
            };
            modalFolderBtn.onclick = function() {
                modalOverlay.style.display = 'none';
                folderInput.click();
            };
            // Hide modal if overlay is clicked (not modal box)
            modalOverlay.onclick = function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            };

            // Preview and upload logic (works for both file and folder input)
            const previewQueue = document.getElementById('previewQueue');
            const currentUpload = document.getElementById('currentUpload');
            let previewBars = [];
            const filesLeft = document.getElementById('filesLeft');
            const uploadTimer = document.getElementById('uploadTimer');

            function estimateUploadTime(fileSize) {
                const MB = 1024 * 1024;
                const typicalSpeedMbps = 50; // Assume 50 Mbps typical connection
                const speedBytesPerSec = (typicalSpeedMbps * 1000000) / 8;
                const timeSeconds = fileSize / speedBytesPerSec;
                if (timeSeconds < 60) {
                    return `~${Math.round(timeSeconds)} seconds`;
                } else if (timeSeconds < 3600) {
                    return `~${Math.round(timeSeconds / 60)} minutes`;
                } else {
                    return `~${Math.round(timeSeconds / 3600)} hours`;
                }
            }

            function handleFileInputChange(input) {
                previewQueue.innerHTML = '';
                previewBars = [];
                filesLeft.style.display = 'none';
                uploadTimer.style.display = 'none';
                if (input.files.length > 0) {
                    // Check for large files (over 1GB)
                    const GB = 1024 * 1024 * 1024;
                    const largeFiles = Array.from(input.files).filter(file => file.size > GB);
                    if (largeFiles.length > 0) {
                        const maxSize = Math.max(...largeFiles.map(f => f.size));
                        const maxSizeGB = (maxSize / GB).toFixed(2);
                        const warningMessage = `⚠️ WARNING: Large File Detected!\n\n📁 Largest file: ${maxSizeGB} GB\n⏰ Upload time: ${estimateUploadTime(maxSize)}\n💾 Memory usage: ~${maxSizeGB} GB RAM needed\n🌐 Network impact: May slow down other devices\n\n❌ Potential issues:\n• Browser may timeout on slow connections\n• Upload failure if network disconnects\n• High memory usage during upload\n• Longer recovery time if upload fails\n\n✅ Click OK to temporarily increase limit and proceed\n❌ Click Cancel to choose smaller files`;
                        if (!confirm(warningMessage)) {
                            input.value = '';
                            return;
                        }
                        // Store the temporary limit increase for the backend
                        sessionStorage.setItem('tempMaxSize', maxSize + (100 * 1024 * 1024)); // Add 100MB buffer
                    }
                    previewQueue.style.display = 'flex';
                    filesLeft.style.display = 'block';
                    filesLeft.textContent = input.files.length + ' / ' + input.files.length + ' file(s) left';
                    uploadTimer.style.display = 'none';
                    uploadTimer.textContent = '';
                    Array.from(input.files).forEach((file, idx) => {
                        const fileDiv = document.createElement('div');
                        fileDiv.style.display = 'flex';
                        fileDiv.style.alignItems = 'center';
                        fileDiv.style.gap = '16px';
                        fileDiv.style.position = 'relative';
                        fileDiv.style.height = '54px';
                        fileDiv.style.background = '#f8fafb';
                        fileDiv.style.borderRadius = '8px';
                        fileDiv.style.marginBottom = '8px';
                        fileDiv.style.boxShadow = '0 1px 4px rgba(0,0,0,0.06)';
                        fileDiv.style.padding = '8px 14px';
                        const thumbWrap = document.createElement('div');
                        thumbWrap.style.flex = 'none';
                        thumbWrap.style.display = 'flex';
                        thumbWrap.style.alignItems = 'center';
                        thumbWrap.style.justifyContent = 'center';
                        thumbWrap.style.width = '44px';
                        thumbWrap.style.height = '38px';
                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.style.width = '38px';
                            img.style.height = '38px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.boxShadow = '0 1px 4px rgba(0,0,0,0.10)';
                            const objectURL = URL.createObjectURL(file);
                            img.src = objectURL;
                            img.onload = () => URL.revokeObjectURL(objectURL); // Clean up memory
                            thumbWrap.appendChild(img);
                        } else if (file.type.startsWith('video/')) {
                            const video = document.createElement('video');
                            video.style.width = '38px';
                            video.style.height = '38px';
                            video.style.objectFit = 'cover';
                            video.style.borderRadius = '6px';
                            video.style.boxShadow = '0 1px 4px rgba(0,0,0,0.10)';
                            const objectURL = URL.createObjectURL(file);
                            video.src = objectURL;
                            video.muted = true;
                            video.playsInline = true;
                            video.preload = 'metadata';
                            video.controls = false;
                            video.autoplay = false;
                            video.addEventListener('mouseenter', () => video.play());
                            video.addEventListener('mouseleave', () => { video.pause(); video.currentTime = 0; });
                            video.addEventListener('loadeddata', () => URL.revokeObjectURL(objectURL)); // Clean up memory
                            thumbWrap.appendChild(video);
                        } else {
                            const icon = document.createElement('span');
                            icon.textContent = '📄';
                            icon.style.fontSize = '1.7em';
                            thumbWrap.appendChild(icon);
                        }
                        fileDiv.appendChild(thumbWrap);
                        const infoWrap = document.createElement('div');
                        infoWrap.style.display = 'flex';
                        infoWrap.style.flexDirection = 'column';
                        infoWrap.style.flex = '1';
                        infoWrap.style.overflow = 'hidden';
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = file.webkitRelativePath || file.name;
                        nameSpan.style.fontSize = '1.08em';
                        nameSpan.style.color = '#333';
                        nameSpan.style.whiteSpace = 'nowrap';
                        nameSpan.style.overflow = 'hidden';
                        nameSpan.style.textOverflow = 'ellipsis';
                        nameSpan.style.display = 'block';
                        infoWrap.appendChild(nameSpan);
                        // Progress bar
                        const barWrap = document.createElement('div');
                        barWrap.style.width = '100%';
                        barWrap.style.height = '8px';
                        barWrap.style.background = '#e9ecef';
                        barWrap.style.borderRadius = '4px';
                        barWrap.style.overflow = 'hidden';
                        barWrap.style.marginTop = '7px';
                        const bar = document.createElement('div');
                        bar.style.height = '100%';
                        bar.style.width = '0%';
                        bar.style.background = '#28a745';
                        bar.style.transition = 'width 0.2s';
                        barWrap.appendChild(bar);
                        infoWrap.appendChild(barWrap);
                        fileDiv.appendChild(infoWrap);
                        previewQueue.appendChild(fileDiv);
                        previewBars.push(bar);
                    });
                } else {
                    previewQueue.style.display = 'none';
                }
            }
            fileInput.addEventListener('change', function() { handleFileInputChange(fileInput); });
            folderInput.addEventListener('change', function() { handleFileInputChange(folderInput); });
        </script>
        <div class="server-ip" style="margin-bottom: 18px;">
          Server URL: <strong><a href="{{ server_url }}" target="_blank">{{ server_url }}</a></strong>
        </div>
        <div id="currentUpload" style="display:none; font-weight:600; margin: 12px 0 8px 0; color:#007bff;"></div>
        <div id="filesLeft" style="display:none; font-weight:500; margin-bottom: 8px; color:#555;"></div>
        <div id="uploadTimer" style="display:none; font-weight:500; margin-bottom: 8px; color:#888;"></div>
        <div id="previewQueue" style="display:none; flex-direction:column; gap:12px; margin: 18px 0 10px 0;"></div>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div style="display: flex; align-items: flex-start; justify-content: flex-end;">
              <button id="closeFlashMessages" title="Hide messages" style="background: none; border: none; font-size: 1.3em; color: #a00; cursor: pointer; margin-bottom: 0; margin-right: 0;">&times;</button>
            </div>
            <div id="flashMessages">
              <ul class="flashes">
              {% for message in messages %}
                <li>{{ message }}</li>
              {% endfor %}
              </ul>
            </div>
            <script>
              document.getElementById('closeFlashMessages').onclick = function() {
                document.getElementById('flashMessages').style.display = 'none';
                this.style.display = 'none';
              };
            </script>
          {% endif %}
        {% endwith %}
    </div>
    <div class="container available-files" style="margin-top: 32px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <h2 style="margin: 0;">Available Files</h2>
        </div>
        <div id="filesTableWrapper">
        <table class="file-table">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>File Name</th>
                    <th>Download</th>
                </tr>
            </thead>
            <tbody>
            {% for file in files %}
                <tr>
                    <td>
                        <div class="preview">
                        {% if previews[file].type == 'text' %}
                            <pre>{{ previews[file].content }}</pre>
                        {% elif previews[file].type == 'image' %}
                            <img src="{{ previews[file].src }}" alt="Image preview" class="img-preview"/>
                        {% elif previews[file].type == 'video' %}
                            <video src="{{ previews[file].src }}" class="img-preview" style="max-width:120px;max-height:80px;" controls preload="metadata"></video>
                        {% else %}
                            <span class="no-preview">No preview available</span>
                        {% endif %}
                        </div>
                    </td>
                    <td style="vertical-align: middle;">{{ file }}</td>
                    <td style="vertical-align: middle;">
                        <a href="{{ url_for('download_file', filename=file) }}" class="download-link">Download</a>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="3">No files uploaded yet.</td></tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</body>
</html> 